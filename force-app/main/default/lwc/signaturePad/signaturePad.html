<template>
    <lightning-card title="Electronic Signature" icon-name="standard:signature">
        <div class="slds-card__body slds-card__body_inner">

            <!-- Loading Spinner -->
            <template if:true={isLoading}>
                <div class="slds-align_absolute-center">
                    <lightning-spinner
                        alternative-text="Loading..."
                        variant="brand"
                        size="medium">
                    </lightning-spinner>
                </div>
            </template>

            <!-- Main Content: Shown when NOT loading and signature is NOT complete -->
            <template if:false={isLoading}>

                <template if:false={isSignatureComplete}>

                    <!-- THIS IS THE CRITICAL FIX: Only render if signatureRequest is loaded -->
                    <template if:true={signatureRequest}>

                        <!-- 1. Document Information -->
                        <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                            <h3 class="slds-text-heading_small slds-m-bottom_small">
                                Document to Sign
                            </h3>
                            <p>{signatureRequest.DocumentId__r.DocumentTitle__c}</p>
                        </div>

                        <!-- 2. Signature Method Selection -->
                        <div class="slds-m-bottom_medium">
                            <lightning-radio-group
                                name="signatureMethod"
                                label="Signature Method"
                                options={signatureMethodOptions}
                                value={selectedSignatureMethod}
                                onchange={handleSignatureMethodChange}
                                type="radio"
                                required>
                            </lightning-radio-group>
                        </div>

                        <!-- 3. Conditional Signature Input Sections -->

                        <template if:true={isTypedSignature}>
                            <div class="signature-section">
                                <lightning-input
                                    type="text"
                                    label="Type your full legal name"
                                    value={typedSignature}
                                    onchange={handleTypedSignatureChange}
                                    required>
                                </lightning-input>

                                <template if:true={typedSignature}>
                                    <div class="signature-preview slds-m-top_small">
                                        <div class="typed-signature-display">
                                            {typedSignature}
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template if:true={isDrawSignature}>
                            <div class="signature-section">
                                <p class="slds-form-element__label slds-m-bottom_small">
                                    Draw your signature in the box below
                                </p>

                                <div class="canvas-container">
                                    <canvas
                                        class="signature-canvas"
                                        width="500"
                                        height="200"
                                        onmousedown={startDrawing}
                                        onmousemove={draw}
                                        onmouseup={stopDrawing}
                                        ontouchstart={startDrawing}
                                        ontouchmove={draw}
                                        ontouchend={stopDrawing}>
                                    </canvas>
                                </div>

                                <div class="slds-text-align_right slds-m-top_x-small">
                                    <lightning-button
                                        label="Clear"
                                        onclick={handleClearCanvas}
                                        variant="neutral">
                                    </lightning-button>
                                </div>
                            </div>
                        </template>

                        <template if:true={isUploadSignature}>
                            <div class="signature-section">
                                <lightning-file-upload
                                    label="Upload an image of your signature"
                                    name="signatureUpload"
                                    accept=".png.jpg.jpeg"
                                    onuploadfinished={handleUploadFinished}
                                    record-id={recordId}
                                    multiple="false">
                                </lightning-file-upload>

                                <template if:true={uploadedSignatureUrl}>
                                    <div class="signature-preview slds-m-top_medium">
                                        <img
                                            src={uploadedSignatureUrl}
                                            alt="Uploaded Signature Preview"
                                            class="uploaded-signature-preview"/>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- 4. Agreement Checkbox -->
                        <div class="slds-m-top_large slds-m-bottom_large">
                            <lightning-input
                                type="checkbox"
                                label="I agree that this electronic signature has the same legal effect as a hand-written signature."
                                checked={agreementAccepted}
                                onchange={handleAgreementChange}
                                required>
                            </lightning-input>
                        </div>

                        <!-- 5. Submit Button -->
                        <div class="slds-text-align_center">
                            <lightning-button
                                variant="brand"
                                label="Submit Signature"
                                title="Submit Signature"
                                onclick={handleSubmitSignature}
                                disabled={isSubmitDisabled}>
                            </lightning-button>
                        </div>

                    </template>
                </template>

                <!-- Signature Complete State -->
                <template if:true={isSignatureComplete}>
                    <div class="slds-box slds-theme_success slds-text-align_center slds-p-around_large">
                        <lightning-icon
                            icon-name="utility:success"
                            variant="success"
                            size="large">
                        </lightning-icon>

                        <h2 class="slds-text-heading_medium slds-m-top_medium">
                            Signature Submitted
                        </h2>
                        <p>Thank you. Your signature has been recorded successfully.</p>
                    </div>
                </template>

            </template>
        </div>
    </lightning-card>
</template>
